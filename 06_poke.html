<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Poke</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>

  <body class="bg-gray-100 flex items-center justify-center min-h-screen">
    <div class="container mx-auto p-4 text-center">
      <h1 class="text-4xl font-bold mb-8">ğŸ“±í¬ì¼“ëª¬ ë„ê°ğŸ“±</h1>

      <section class="mb-8 p-6 bg-white rounded-lg shadow-md">
        <label for="pokeId" class="mr-2 font-bold text-gray-700"
          >í¬ì¼“ëª¬ ID :</label
        >
        <input
          id="pokeId"
          type="number"
          min="1"
          class="border rounded px-2 py-1 w-24 text-center"
        />
        <button
          id="pokeBtn"
          class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-1 px-4 rounded"
        >
          ê²€ìƒ‰
        </button>
      </section>

      <section id="pokeBox" class="p-6 bg-white rounded-lg shadow-md"></section>
    </div>

    <script>
      // ë¡œë§ˆ ìˆ«ì â†’ ì„¸ëŒ€ ìˆ«ì
      const romanToNumber = {
        i: 1,
        ii: 2,
        iii: 3,
        iv: 4,
        v: 5,
        vi: 6,
        vii: 7,
        viii: 8,
        ix: 9,
      };

      // 1. APIì—ì„œ ë°ì´í„° í˜¸ì¶œ
      async function getPokemon(id) {
        if (!id) {
          alert("í¬ì¼“ëª¬ IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
          return;
        }

        console.log(`${id}ë²ˆ í¬ì¼“ëª¬ì„ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤`);

        try {
          const response = await fetch(
            `https://pokeapi.co/api/v2/pokemon/${id}`
          );
          if (!response.ok) throw new Error("Pokemon not found!");
          const data = await response.json();

          const response2 = await fetch(
            `https://pokeapi.co/api/v2/pokemon-species/${id}`
          );
          if (!response2.ok) throw new Error("Pokemon species not found!");
          const data2 = await response2.json();

          // í•œê¸€ ì´ë¦„
          const koNameObj = data2.names.find((v) => v.language.name === "ko");
          const koName = koNameObj ? koNameObj.name : data.name;

          // ì„¸ëŒ€
          let genStr = data2.generation.name.replace("generation-", ""); // i, ii, iii...
          const generation = romanToNumber[genStr]
            ? `${romanToNumber[genStr]}ì„¸ëŒ€`
            : genStr;

          // ì„¤ëª…
          const flavorTextObj = data2.flavor_text_entries.find(
            (entry) => entry.language.name === "ko"
          );
          const description = flavorTextObj
            ? flavorTextObj.flavor_text.replace(/\n|\f/g, " ")
            : "ì„¤ëª…ì´ ì—†ìŠµë‹ˆë‹¤.";

          // í¬ì¼“ëª¬ ë°ì´í„° ê°ì²´
          const pokeData = {
            engName: data.name,
            koName,
            shape: data.sprites.front_default,
            sound: data.cries ? data.cries.latest : "",
            generation,
            description,
          };

          renderPoke(pokeData);
          localStorage.setItem("recent", JSON.stringify(pokeData));
        } catch (error) {
          console.error("Error fetching Pokemon data:", error);
          alert("í¬ì¼“ëª¬ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. IDë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.");
          document.querySelector("#pokeBox").innerHTML = "";
        }
      }

      // 2. input ì´ë²¤íŠ¸
      const pokeBtn = document.querySelector("#pokeBtn");
      const pokeIdInput = document.querySelector("#pokeId");

      pokeBtn.addEventListener("click", () => getPokemon(pokeIdInput.value));
      pokeIdInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") getPokemon(pokeIdInput.value);
      });

      // 3. í™”ë©´ì— í‘œì‹œ
      function renderPoke({
        engName,
        koName,
        shape,
        sound,
        generation,
        description,
      }) {
        const pokeBox = document.querySelector("#pokeBox");
        pokeBox.innerHTML = `
          <h4 class="text-2xl font-bold mb-2">${koName}</h4>
          <h5 class="text-xl text-gray-600 mb-2">${engName}</h5>
          <p class="text-gray-700 mb-2">${generation} í¬ì¼“ëª¬</p>
          <img src="${shape}" width=300 height=300 class="mx-auto mb-4 rounded-lg shadow-lg">
          <p class="text-gray-700 mb-4">ì„¤ëª… : ${description}</p>
          ${
            sound
              ? `<audio src="${sound}" controls class="mx-auto"></audio>`
              : ""
          }
        `;
      }

      // 4. ì§ì „ ê²€ìƒ‰ ë°ì´í„° ìë™ ë¡œë”©
      document.addEventListener("DOMContentLoaded", () => {
        const rawRecentPoke = localStorage.getItem("recent");
        if (!rawRecentPoke) return;
        const poke = JSON.parse(rawRecentPoke);
        renderPoke(poke);
      });
    </script>
  </body>
</html>
