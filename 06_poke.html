<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Poke</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>

  <body class="bg-gray-100 flex items-center justify-center min-h-screen">
    <div class="container mx-auto p-4 text-center">
      <h1 class="text-4xl font-bold mb-8">📱포켓몬 도감📱</h1>

      <section class="mb-8 p-6 bg-white rounded-lg shadow-md">
        <label for="pokeId" class="mr-2 font-bold text-gray-700"
          >포켓몬 ID :</label
        >
        <input
          id="pokeId"
          type="number"
          min="1"
          class="border rounded px-2 py-1 w-24 text-center"
        />
        <button
          id="pokeBtn"
          class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-1 px-4 rounded"
        >
          검색
        </button>
      </section>

      <section id="pokeBox" class="p-6 bg-white rounded-lg shadow-md"></section>
    </div>

    <script>
      // 로마 숫자 → 세대 숫자
      const romanToNumber = {
        i: 1,
        ii: 2,
        iii: 3,
        iv: 4,
        v: 5,
        vi: 6,
        vii: 7,
        viii: 8,
        ix: 9,
      };

      // 1. API에서 데이터 호출
      async function getPokemon(id) {
        if (!id) {
          alert("포켓몬 ID를 입력해주세요.");
          return;
        }

        console.log(`${id}번 포켓몬을 불러옵니다`);

        try {
          const response = await fetch(
            `https://pokeapi.co/api/v2/pokemon/${id}`
          );
          if (!response.ok) throw new Error("Pokemon not found!");
          const data = await response.json();

          const response2 = await fetch(
            `https://pokeapi.co/api/v2/pokemon-species/${id}`
          );
          if (!response2.ok) throw new Error("Pokemon species not found!");
          const data2 = await response2.json();

          // 한글 이름
          const koNameObj = data2.names.find((v) => v.language.name === "ko");
          const koName = koNameObj ? koNameObj.name : data.name;

          // 세대
          let genStr = data2.generation.name.replace("generation-", ""); // i, ii, iii...
          const generation = romanToNumber[genStr]
            ? `${romanToNumber[genStr]}세대`
            : genStr;

          // 설명
          const flavorTextObj = data2.flavor_text_entries.find(
            (entry) => entry.language.name === "ko"
          );
          const description = flavorTextObj
            ? flavorTextObj.flavor_text.replace(/\n|\f/g, " ")
            : "설명이 없습니다.";

          // 포켓몬 데이터 객체
          const pokeData = {
            engName: data.name,
            koName,
            shape: data.sprites.front_default,
            sound: data.cries ? data.cries.latest : "",
            generation,
            description,
          };

          renderPoke(pokeData);
          localStorage.setItem("recent", JSON.stringify(pokeData));
        } catch (error) {
          console.error("Error fetching Pokemon data:", error);
          alert("포켓몬을 찾을 수 없습니다. ID를 확인해주세요.");
          document.querySelector("#pokeBox").innerHTML = "";
        }
      }

      // 2. input 이벤트
      const pokeBtn = document.querySelector("#pokeBtn");
      const pokeIdInput = document.querySelector("#pokeId");

      pokeBtn.addEventListener("click", () => getPokemon(pokeIdInput.value));
      pokeIdInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") getPokemon(pokeIdInput.value);
      });

      // 3. 화면에 표시
      function renderPoke({
        engName,
        koName,
        shape,
        sound,
        generation,
        description,
      }) {
        const pokeBox = document.querySelector("#pokeBox");
        pokeBox.innerHTML = `
          <h4 class="text-2xl font-bold mb-2">${koName}</h4>
          <h5 class="text-xl text-gray-600 mb-2">${engName}</h5>
          <p class="text-gray-700 mb-2">${generation} 포켓몬</p>
          <img src="${shape}" width=300 height=300 class="mx-auto mb-4 rounded-lg shadow-lg">
          <p class="text-gray-700 mb-4">설명 : ${description}</p>
          ${
            sound
              ? `<audio src="${sound}" controls class="mx-auto"></audio>`
              : ""
          }
        `;
      }

      // 4. 직전 검색 데이터 자동 로딩
      document.addEventListener("DOMContentLoaded", () => {
        const rawRecentPoke = localStorage.getItem("recent");
        if (!rawRecentPoke) return;
        const poke = JSON.parse(rawRecentPoke);
        renderPoke(poke);
      });
    </script>
  </body>
</html>
